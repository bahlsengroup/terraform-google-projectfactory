# This file was generated by the bootstrap.sh script from the
# https://github.com/bahlsengroup/terraform-google-projectfactory repository

module "project_factory" {
  source     = "bahlsengroup/projectfactory/google"
  version    = "~> ${MODULE_VERSION}"
  project_id = local.project_id

  # The module automatically grants the same permissions to the Manager, Developer and
  # Observer groups as the panel does. There is no need to explicitly configure them.
  # All other bindings in the project's IAM policy can be configured here:
  # iam_policy = [
  #   # Allow manager group to use this project
  #   # as billing project for BigQuery jobs
  #   {
  #     role = "roles/bigquery.jobUser"
  #     members = [
  #       local.iam_group,
  #     ]
  #   },
  #   # Same for developer group, but only during working days from 07:00 to 18:59
  #   {
  #     role = "roles/bigquery.jobUser"
  #     members = [
  #       local.iam_group,
  #     ]
  #     condition = {
  #       title       = "Working Hours"
  #       description = "Allow during working hours (Monday-Friday, 7:00 to 18:59)"
  #       expression  = <<-EOC
  #         request.time.getHours('Europe/Berlin') >= 7 &&
  #         request.time.getHours('Europe/Berlin') < 19 &&
  #         // Days of the week range from 0 to 6, where 0 == Sunday and 6 == Saturday.
  #         request.time.getDayOfWeek('Europe/Berlin') >= 1 &&
  #         request.time.getDayOfWeek('Europe/Berlin') <= 5
  #       EOC
  #     }
  #   }
  # ]

  service_accounts = {
    "${IAC_SA_SHORT_NAME}" = {
      display_name = "Terraform IaC pipelines"
      description  = "Service account used in IaC pipeline"
      iam_policy   = [
        {
            role    = "roles/iam.serviceAccountTokenCreator"
            members = [
                # Allow manager group to impersonate IaC service account
                local.iam_group,
                # Allow service account to impersonate itself, useful for pipelines
                local.iam_iac_service_account
            ]
        }
      ]
      project_iam_policy_roles = [
        ${IAC_SA_ROLES}
      ]
      ${IAC_SA_GITHUB_REPOSITORY_STRING}
    }
  }

  # List of enabled services
  enabled_services = [
    # Bootstrap creates a GCS bucket in the module to hold the Terraform state,
    # see: tf-state-bucket.tf file. Therefore we also ensure the service is
    # enabled.
    "storage.googleapis.com",
  ]
}
